<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Comprendre et optimiser les performances de son projet QGIS</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />

    <link rel="stylesheet" href="./css/oslandia.css" />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown data-separator="\r?\n---\r?\n" data-separator-vertical="\r?\n----\r?\n">
          <textarea data-template>
            

<style>
img {
margin:0 !important;
vertical-align:top !important;
}
table td {
border-bottom: 0 !important;
padding-left: 0 !important;
vertical-align:top !important;
}
</style>

## Comprendre et optimiser les performances de son projet QGIS

Rencontres des Utilisateurs Francophones de QGIS<br/>
Avignon - 10/06/2025
</td><td><img src="banniere.png" box-shadow="none"></img></td>

Julien Cabieces / Jacky Volpes 

<img src="oslandia_logo_164x164.png" height="150" />

---

### Qui sommes nous ?

<table vertical-align="middle">
<tr>
</td>
<td><img text-align="center" src="juc_rond.png" height="250" /></td>
<td>
Julien Cabieces<br/>
Developpeur C++/Python<br/>
QGIS Core committer<br/>
<img text-align="center" src="github_logo.svg" height="32" width="32"/><em>@troopa81</em><br/>
<img text-align="center" src="mastodon_logo.svg" height="32" width="32"/><em>@CabiecesJ@mapstodon.space</em>
</tr>
</table>

<table vertical-align="middle">
<tr>
<td>
Jacky Volpes<br/>
Developpeur C++/Python<br/>
Contributeur coeur QGIS & Plugins<br/>
<img text-align="center" src="github_logo.svg" height="32" width="32"/><em>@Djedouas</em><br/>
<img text-align="center" src="mastodon_logo.svg" height="32" width="32"/><em>@djedouas@mamot.fr</em>
</ul>
</td>
<td><img text-align="center" src="jvo_rond.png" height="250" /></td>
</tr>
</table>


---

## Plan de l'atelier

D√©bugger des projets

---

## Pr√©requis (1/2)

- T√©l√©charger le [dump SQL](https://share.oslandia.net/s/FZAL5yCaBrYDbmF) pour la base de donn√©es

```shell
$ createdb ws_qgis_debug
$ pg_dump -d ws_qgis_debug -f ws_qgis_debug.sql
```

- Configurer votre fichier [.pg_service.conf](https://docs.qgis.org/3.40/fr/docs/user_manual/managing_data_source/opening_data.html#postgresql-service-connection-file) avec le nom *[ws_qgis_debug]*

**Puis ...** (fl√®che de droit pour la slide suivante)

---

## Pr√©requis (2/2)
- [Ajouter](https://docs.qgis.org/3.40/fr/docs/user_manual/managing_data_source/opening_data.html#connecting-to-postgresql) la base de donn√©es dans QGIS

<img src="connexion.png" />

- Ouvrir le projet [communes](communes/communes.qgz)

---

## Origine des donn√©es

- Communes t√©l√©charg√©es [ici](https://www.data.gouv.fr/fr/datasets/decoupage-administratif-communal-francais-issu-d-openstreetmap/)
- üá´üáÆ [GISPO](https://www.gispo.fi/en/) [performance test](https://github.com/GispoCoding/qgis-postgis-performance-test)

---

## Pr√©paration des donn√©es
#### C'est d√©j√† fait

Communes

```shell
$ createdb ws_qgis_debug
$ psql -d ws_qgis_debug -c 'create extension postgis;'
CREATE EXTENSION
$ ogr2ogr -f "PostgreSQL" PG:"host=127.0.0.1 user=julien dbname=ws_qgis_debug" \
	/home/julien/T√©l√©chargements/communes-20220101-shp/communes-20220101.shp \
	-nlt MULTIPOLYGON
```
Communes coti√®res

```sql
  create view communes_cotieres as
    select * from communes_20220101 c
    where not st_isempty(st_difference(st_boundary(c.wkb_geometry),
				       (select st_collect(ic.wkb_geometry) 
					   from communes_20220101 ic 
					   where ic.wkb_geometry && c.wkb_geometry 
					   AND ic.ogc_fid != c.ogc_fid )));
```

Pour la th√©matique sur les [expressions](https://github.com/GispoCoding/qgis-postgis-performance-test?tab=readme-ov-file#to-reproduce-the-issue)


---

## Communes

---

### Communes: Identifier la requ√™te

- Ouvrir le projet [communes](communes/communes.qgz)
- Zoomer sur une r√©gion (exemple: Occitanie)
- Clic droit barre d'outils
  - ‚û°Ô∏è *Panneaux* ‚û°Ô∏è *Outils de debogage et d√©veloppement*
- Onglet *Enregistreur de requ√™tes* <img style="vertical-align:middle !important"  src="dbmanager.svg"  />
- Effacer le journal <img style="vertical-align:middle !important"  src="mActionDeleteSelected.svg"  />
- Activer l'enregistrement <img style="vertical-align:middle !important"  src="mActionRecord.svg"  />
- Se d√©placer !

---

### Communes: Identifier la requ√™te

<img src="communes/debug.png" />

---

### Communes: Requ√™tes en 2 √©tapes

D√©claration du curseur

```sql 
BEGIN READ ONLY;DECLARE qgis_422 BINARY CURSOR FOR SELECT ...
```

R√©cup√©ration des donn√©es

```sql
FETCH FORWARD 2000 FROM qgis_422
```

Seule la 2√®me a une latence, mais nous sommes int√©ress√©s par la 1√®re ü§î

---

### Communes: D√©bugger la requ√™te

- Clic droit sur la d√©claration du curseur ‚û°Ô∏è Copier le SQL
- Ouvrir une console **psql**
- Remplacer 
  - **BEGIN READ ONLY;DECLARE qgis_422 BINARY CURSOR FOR** 
  - par
  - **EXPLAIN ANALYZE**
- Ex√©cuter

```sql
EXPLAIN ANALYZE SELECT st_asbinary("wkb_geometry",'NDR'),"ogc_fid" FROM "public"."communes_20220101" WHERE "wkb_geometry" && st_makeenvelope(0.62040804636523017,44.39446078289464026,4.48068239699022097,47.16706034793472213,4326)
```
---

### Communes: EXPLAIN

```
           QUERY PLAN                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Seq Scan on communes_20220101  (cost=0.00..17929.06 rows=5281 width=36)
   Filter: (wkb_geometry && '0103000020E610000001000000050000004830C479D959E0BFCB41498B36B145404830C479D959E0BFEBA12D161B144740EE205B2661CB0A40EBA12D161B144740EE205B2661CB0A40CB41498B36B145404830C479D959E0BFCB41498B36B14540'::geometry)
(2 lignes)
```

??? Qu'est-ce qui cloche üîî ???

---

### [Solution] Communes: Seq Scan

- Scan s√©quentiel: A chaque requ√™te
  - Postgres lit Toute la table
  - filtre les g√©om√©tries 1 par 1 üò±

‚û°Ô∏è Il manque un index 

---

### Apart√©: les index

- Index spatiaux ‚û°Ô∏è extension du principe d'index
- Diff√©rents types: b-tree, **GiST**, SP-GiST, BRIN
- GiST: Arbre de Bounding BOX pour un acc√©s rapide

<img src="communes/index_principe2.png" height="500" />

---

### Communes: On ajoute un index

```sql
CREATE INDEX communes_gist_idx ON communes_20220101 USING GIST ( wkb_geometry );
```

on relance le EXPLAIN

```                                                                                                                      QUERY PLAN                                                                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on communes_20220101  (cost=153.21..12007.29 rows=5281 width=36)
   Recheck Cond: (wkb_geometry && '0103000020E610000001000000050000004830C479D959E0BFCB41498B36B145404830C479D959E0BFEBA12D161B144740EE205B2661CB0A40EBA12D161B144740EE205B2661CB0A40CB41498B36B145404830C479D959E0BFCB41498B36B14540'::geometry)
   ->  Bitmap Index Scan on communes_gist_idx  (cost=0.00..151.89 rows=5281 width=0)
         Index Cond: (wkb_geometry && '0103000020E610000001000000050000004830C479D959E0BFCB41498B36B145404830C479D959E0BFEBA12D161B144740EE205B2661CB0A40EBA12D161B144740EE205B2661CB0A40CB41498B36B145404830C479D959E0BFCB41498B36B14540'::geometry)
(4 lignes)
```

---

### Communes: Avant / Apr√©s

<img src="communes/debug_after.png" height="500" />

‚ö†Ô∏è La r√©cup√©ration de la donn√©e (g√©om√©trie notamment) prends aussi du temps

---

### Communes: BONUS

D√©zoomer au niveau de la france et analysez la requ√™te

Expliquez ce que vous voyez

---

### [Solution] Communes: BONUS


```sql
          QUERY PLAN                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Seq Scan on communes_20220101  (cost=0.00..21621.31 rows=34819 width=36) (actual time=0.057..145.882 rows=34707 loops=1)
   Filter: (wkb_geometry && '0103000020E61000000100000005000000FC291879E9501AC0E9219FB290154540FC291879E9501AC0E945E62D35D749406098A9CEA8312740E945E62D35D749406098A9CEA8312740E9219FB290154540FC291879E9501AC0E9219FB290154540'::geometry)
   Rows Removed by Filter: 248
 Planning Time: 0.383 ms
 Execution Time: 146.743 ms
(5 lignes)

```

- On retombe sur un scan s√©quentiel
- On veut toutes les communes, l'index est inutile

---

## Communes commen√ßant par "Saint" üôè

---

###  Communes "Saint"

- Ouvrir le projet [communes_saints](communes_saints/communes_saints.qgz)
- Appliquer la m√©thode d√©crite pr√©c√©demment pour optimiser

---

### [Solution] Communes "Saint"

Cr√©er un index sur le nom

```sql
create index communes_nom_idx on communes_20220101 (nom text_pattern_ops);
```

- Ne fonctionne pas si on veut les communes qui **contiennent** "Saint". 
- On peut alors utiliser **pg_trgm**

```sql
CREATE EXTENSION pg_trgm;
create index communes_nom_pg_trm_idx on communes_20220101 using gist (nom gist_trgm_ops);
```

---

### Communes "Saint": Avant/Apr√©s

<img src="communes_saints/beforeafter.png" height="500" />

---

## Les communes coti√®res

---

### Les communes coti√®res

- Depuis *Outils de debogage et d√©veloppement*
  - onglet *Profileur* <img style="vertical-align:middle !important" src="cotieres/mIconStopwatch.svg" />
  - Cat√©gorie "Projet charg√©" 
	- si absent, masquer/afficher l'outil de deboggage üêû

- Ouvrir le projet [cotieres](cotieres/cotieres.qgz)
- Qu'observez vous?
- Comment am√©liorer ?

---

### [Solution] Coti√®res: Identification du probl√®me

- Grosse latence d√©s le chargement (1 minute 30)
- Application bloqu√©e

<img src="cotieres/loadproject.png" height="400" />

---

### [Solution] Coti√®res: Identification du probl√®me

```sql
SELECT count(distinct ("ogc_fid"))=count(("ogc_fid")) FROM "public"."communes_cotieres"
```

- QGIS essai de savoir s'il y a une cl√© unique !

---

### [Solution] Coti√®res: Param√®tres du chargement de couche

Ne pas v√©rifier l'unicit√© des cl√©s

<img src="cotieres/unicity.png" />

---

### [Solution] Coti√®res: Param√®tres du chargement de couche

Projet de confiance pour les sources de donn√©es

<img src="cotieres/trust.png" />

‚ö†Ô∏è Ne fonctionne que lors d'un chargement d'un projet, pas lors de l'ajout de couche üêû

---

### [Solution] Coti√®res: Param√®tres du chargement de couche

Utiliser la table des m√©ta-donn√©es estim√©es

<img src="cotieres/metadata.png" />

‚ö†Ô∏è Ne fonctionne pas dans ce cas l√† üêû

---

### Coti√®res: Chargement des couches

üöß Am√©liorations √† pr√©voir üöß
- Grouper les requ√™tes de m√©ta-donn√©es pour toutes les couches
- Meilleur configurabilit√© des optimisations
  - pour un projet/par couche/par connexion
  - par optimisation (champs unique, type de g√©om√©trie, extent...)

üí∏ On cherche des financeurs üí∏

---

### [Solution] Coti√®res: Et sinon √ßa rame toujours... üö£üèª

```sql
CREATE MATERIALIZED VIEW cotieres_mat AS select * from communes_cotieres;
```
---

## Expression

Merci GISPO üá´üáÆ pour les donn√©es!

---

### Expression

- Ouvrir le [projet](expression/expression.qgz)
- Optimisez

---

### [Solution] Expression : Premi√®re requ√™te


```sql 
EXPLAIN ANALYZE SELECT "id_contact"::text,"id_building"::text FROM "qgisdbtest"."building_owners" WHERE ("id_building" = 44116);
                                                  QUERY PLAN                                                  
--------------------------------------------------------------------------------------------------------------
 Seq Scan on building_owners  (cost=0.00..3740.47 rows=1 width=64) (actual time=5.069..22.486 rows=2 loops=1)
   Filter: (id_building = 44116)
   Rows Removed by Filter: 220995
 Planning Time: 0.586 ms
 Execution Time: 22.542 ms
(5 lignes)
```

Pas de **Index Scan**. Pourtant

```sql
\d qgisdbtest.building_owners
...
Index :
    "building_owners_pk" PRIMARY KEY, btree (id_contact, id_building)
```

Index sur le couple *id_contact*, *id_building*, mais pas sur *id_building* seul.

---

### [Solution] Expression 

Cr√©ons l'index 

```sql
create index bo_id_idx on gisdbtest.building_owners ( id_building )
```

```sql
EXPLAIN ANALYZE SELECT "id_contact"::text,"id_building"::text FROM "qgisdbtest"."building_owners" WHERE ("id_building" = 44116);
                                                         QUERY PLAN                                                         
----------------------------------------------------------------------------------------------------------------------------
 Index Scan using bo_id_idx on building_owners  (cost=0.42..8.45 rows=1 width=64) (actual time=0.043..0.047 rows=2 loops=1)
   Index Cond: (id_building = 44116)
 Planning Time: 0.300 ms
 Execution Time: 0.067 ms
(4 lignes)
```

Mieux, mais √ßa rame encore ...

---

### [Solution] Expression : Deuxi√®me requ√™te

```sql
EXPLAIN ANALYZE FOR SELECT "id","name"::text FROM "qgisdbtest"."contact" WHERE "id"=10;
```

- Seq scan au lieu de index scan
  - Trop peu de valeurs 
  - Index scan n√©cessite une lecture pr√©alable dans l'index
  - PostGresql pr√©f√®re lire une table en Seq scan
  - A valider en ajouter des donn√©es

OK, mais √ßa rame toujours ...

---

### [Solution] Expression

- Mais qu'est-ce qui ralentit le rendu ?

- 2 M√©thodes
  - On analyze la requ√™te 
    - "Qui a besoin de r√©cup√©rer le lien entre building et le champs nom du contact
  - M√©thode vieille comme la nuit des temps ü¶ï
    - On d√©sactive 1 par 1 les couches/symbologie
    - On isole le coupable üïµÔ∏è

---

### [Solution] Expression

üöì Le coupable est: l'expression des √©tiquettes du building 


```
relation_aggregate(
	'building_owners_eb7ff7ce_9fb2_49f1_af7c_7f662f03acd4_id_building_building_ffbf4145_36d9_4e70_9aec_b35452629b36_id', 
	'concatenate',
	attribute(
		get_feature_by_id(
			'contact_0e70b878_8eb7_44e6_af1d_dcc568a6e95f',
			id_contact),
		'name'), 
	',')
````

- Pour chaque building, QGIS lance 2 requ√™tes pour:
  - R√©cup√©rer l'*id_contact* du *building*
  - R√©cup√©rer le nom du contact depuis l'*id_contact*

- ‚úÖ Requ√™tes sont courtes...
- ‚ùå Mais trop nombreuses!

---

### [Solution] Expression

Cr√©er une view üëÅÔ∏è

```sql
CREATE VIEW qgisdbtest.building_with_owners AS
SELECT b.*, STRING_AGG(c.name, ', ') AS owners
FROM qgisdbtest.building b
JOIN qgisdbtest.building_owners AS bo ON b.id = bo.id_building
JOIN qgisdbtest.contact AS c ON bo.id_contact = c.id
GROUP BY b.id;
```

- Ajouter la nouvelle vue
- Copier/Coller le style
- √âditer le champs des √©tiquettes

Le rendu est maintenant rapide ü™Ñ

---

### Expression: BONUS

Pourquoi la "m√™me" requ√™te est ex√©cut√©e plusieurs fois ?

---

### [Solution] Expression: BONUS

- QGIS pr√©charge les tuiles autour de la zone de rendu
  - Utiles pour les tuiles XYZ, WMS...
  - Mais re-requ√™te tout le temps les donn√©es de base
	- Au cas o√π elle est chang√©√©
- Soit 9 zones en tout ‚û°Ô∏è 9 requ√™tes

<img src="expression/preload.png" height="300" />

---

## COG: Cloud Optimized Geotiff

---

### COG: Acc√©s distant raster

C'est [impossible](https://github.com/qgis/QGIS/issues/53351) pour l'instant üò≠

- Attention √† la pr√©cision des donn√©es
  - Exemple: Sentinel en UInt16 pour afficher en RGB (8 bits)
	R√©cup√®re 2 x trop de donn√©es

---

## Tuiles XYZ, WMS

---

### OpenStreetMap üó∫Ô∏è

- Depuis l'explorateur, noeud *Tuiles XYZ*, ajouter OpenStreetmap
- Depuis *Outils de debogage et d√©veloppement*
  - onglet *Journal de bord du r√©seau* <img style="vertical-align:middle !important" src="network_and_proxy.svg" />
- Se d√©placer

 Il manque le temps des requ√™tes üò¢

---

## Questions

Rencontres des Utilisateurs Francophones de QGIS<br/>
Avignon - 10/06/2025
</td><td><img src="banniere.png" box-shadow="none"></img></td>

Julien Cabieces / Jacky Volpes 

<img height=150px src="oslandia_logo_164x164.png">

          </textarea>
        </section>
      </div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./mermaid/dist/mermaid.min.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        slideNumber: true,
        highlight: {
          highlightOnLoad: false
        },
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"_":["."],"css":"./oslandia.css","static":"/home/julien/work/presentations/ws_qgis_debug"}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
      Reveal.addEventListener('ready', function (event) {
        const blocks = Reveal.getRevealElement().querySelectorAll('pre code:not(.mermaid)');
        const hlp = Reveal.getPlugin('highlight');
        blocks.forEach(hlp.highlightBlock);
      });
    </script>

    <script>
      const mermaidOptions = extend({ startOnLoad: false }, {});
      mermaid.startOnLoad = false;
      mermaid.initialize(mermaidOptions);
      const cb = function (event) { mermaid.init(mermaidOptions, '.stack.present>.present pre code.mermaid'); };
      Reveal.addEventListener('ready', cb);
      Reveal.addEventListener('slidetransitionend', cb);
    </script>
  </body>
</html>
