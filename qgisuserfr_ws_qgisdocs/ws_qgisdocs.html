<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Associer vos documents et vos donn√©es avec QGIS</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />

    <link rel="stylesheet" href="./css/oslandia.css" />

  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

<style>
img {
margin:0 !important;
vertical-align:top !important;
}
table td {
border-bottom: 0 !important;
padding-left: 0 !important;
vertical-align:top !important;
}
</style>

## Associer vos documents et vos donn√©es avec QGIS

Rencontres des Utilisateurs Francophones de QGIS<br/>
Clermont-Ferrand - 13/03/2023
</td><td><img src="rencontres_header.png" box-shadow="none"></img></td>

Julien Cabieces / Jacky Volpes

<img src="oslandia_logo_164x164.png" height="150" />
</script></section><section  data-markdown><script type="text/template">
### Qui sommes nous ?

<table vertical-align="middle">
<tr><td><img text-align="center" src="juc_rond.png" height="250" /></td>
<td>
Julien Cabieces<br/>
Developpeur C++/Python<br/>
QGIS Core committer<br/>
<img text-align="center" src="github_logo.svg" height="32" width="32"/><em>@troopa81</em><br/>
<img text-align="center" src="twitter_logo.svg" height="32" width="32"/><em>@CabiecesJ</em><br/>
<img text-align="center" src="mastodon_logo.svg" height="32" width="32"/><em>@CabiecesJ@mapstodon.space</em>
</td>
</tr>
</table>

<table vertical-align="middle">
<tr>
<td>
Jacky Volpes<br/>
Developpeur C++/Python<br/>
Contributeur coeur QGIS & Plugins<br/>
<img text-align="center" src="github_logo.svg" height="32" width="32"/><em>@Djedouas</em><br/>
<img text-align="center" src="mastodon_logo.svg" height="32" width="32"/><em>@djedouas@mamot.fr</em>
</ul>
</td>
<td><img text-align="center" src="jvo_rond.png" height="250" /></td>
</tr>
</table>
</script></section><section  data-markdown><script type="text/template">
## Probl√©matique

- **Besoin**: Associer des fichiers √† de la donn√©e m√©tier
  - Photo d‚Äôun vandalisme
  - Vid√©o d‚Äôune canalisation lors d‚Äôun entretien
  - Manuel PDF d‚Äôun √©quipement (borne √©lectrique)

- **Donn√©e**: stock√©e en base
  - ... ou pas (Fonctionne aussi avec des fichiers)

- **Documents**
  - En local sur le disque
  - Dans un r√©pertoire partag√©
  - Dans un syst√®me de GED (Gestion √âlectronique de Documents)

- Initi√© et financ√© par la m√©tropole de Lille
</script></section><section  data-markdown><script type="text/template">
## But de de l'atelier

##### Comment lier ses donn√©es de base de donn√©es avec des documents ?

##### Comment configurer QGIS pour obtenir un workflow efficace ?
</script></section><section  data-markdown><script type="text/template">
## Cas d'utilisation

- Donn√©es : des monuments
- Documents : 
  - Photo
  - Vid√©o
  - Page HTML de pr√©sentation

<br/><img src="cathedrale_poly.png" height="200" />
<img src="cathedrale.png" height="200"/>
</script></section><section  data-markdown><script type="text/template">

## Le mod√®le de donn√©es

<img src="datamodel_sel.png" height="500" />
</script></section><section  data-markdown><script type="text/template">
## Initialiser le mod√®le de donn√©es

Cr√©er la base
```shell
createdb qgis_docs
```

V√©rifier que l'on peut s'y connecter
```shell
psql qgis_docs
```

R√©cup√©rer le fichier [external_storage.sql](external_storage.sql) et chargez le
```shell
psql qgis_docs -f external_storage.sql
```

R√©cup√©rer les documents [lille_docs.zip](lille_docs.zip)
</script></section><section  data-markdown><script type="text/template">
### üëÄ Jetons un oeil au mod√®le de donn√©es

<img src="datamodel_sql.png" height="500" />
</script></section><section  data-markdown><script type="text/template">
### Et maintenant dans QGIS...

- On cr√©e la connexion : *Explorateur > PostgreSQL > Nouvelle connexion...*
  - Nom: qgis_docs
  - H√¥te: 127.0.0.1
  - port: 5432
  - Base de donn√©es: qgis_docs
  - **Authentification si pas en trust sur connexion locale**
  - ‚ö†Ô∏è Cocher *Lister les tables sans g√©om√©tries*
  
<img src="monuments_in_qgis.png"/>
</script></section><section  data-markdown><script type="text/template">
### Et initialiser le projet ...

- S√©lectionner les 2 tables *monuments* et *documents*
- Puis *Ajouter les tables s√©lectionn√©es au projet*
- **BONUS** Ajouter une couche OpenStreetMap
  - et changer le CRS du projet : **3857**
</script></section><section  data-markdown><script type="text/template">
### D√©couvrir les relations

<img src="discover_relations.png" height="400"/>

* *Projet > Propri√©t√©s > Relations*
* *D√©couvrir les relations*
* *Tout s√©lectionner > OK*
</script></section><section  data-markdown><script type="text/template">
### Configurer les sources de donn√©es

<img src="conf_datasource.png" height="500"/>

Pour plus de de d√©tails voir l'atelier [QGIS & PostGIS Trucs & Astuces](https://troopa81.github.io/presentations/qgisuserfr_ws_postgis_qgis/ws_postgis_qgis.html#/) sur les relations
</script></section><section  data-markdown><script type="text/template">
### Configurer le formulaire monuments

<img src="edit_form.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
## Ajouter un document

Depuis le formulaire monument

<img src="edit_url_simple.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
## Am√©liorer l'int√©gration

Configurer le formulaire document

<img src="conf_form_docs.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### Am√©liorer l'int√©gration

<img src="monument_preview.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### C'est bien mais pas top

- Il faut copier-coller le fichier au bon endroit
- Copier l'url
- Coller l'url
</script></section><section  data-markdown><script type="text/template">
## Configurer Copie simple

Choisir **Copie simple** comme type de stockage

<img src="conf_copie_simple.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### Fonctionnement Copie simple

Avec un r√©pertoire centralis√© (partag√© dans l'id√©al)

<img src="schema_copie_simple.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### Formulaire Copie simple

Une fois le fichier s√©lectionn√© de n'importe o√π, il est copi√©
vers le dossier centralis√© et accessible √† tous

<img src="form_copie_simple.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### **Astuce** Ajout par glisser-d√©poser

<img src="glisser_deposer.png" height="450"/>
</script></section><section  data-markdown><script type="text/template">
## GED 

**G**estion **√â**lectronique de **D**ocument

Les possibles:
- Nextcloud
- Minio
- Pydio
- Sharepoint

Protocoles :
- WebDAV
- S3
</script></section><section  data-markdown><script type="text/template">
## Nextcloud

- logiciel libre 
- üëâ site d'h√©bergement de fichiers üëà
- protocole WebDAV
- une plateforme de collaboration
- Fork√© de Owncloud en 2017

<br/>
<a href="https://nextcloud.com"><img src="nextcloud.png" height="200" /></a>
</script></section><section  data-markdown><script type="text/template">
## Nextcloud

- Instance de test ici [http://ns6640565.ip-51-254-43.eu:4251](http://ns6640565.ip-51-254-43.eu:4251)
- temporaire, le temps du workshop
- Pour tester chez vous üè† :
  - [https://try.nextcloud.com/](https://try.nextcloud.com/)
  - Avec [docker](docker-compose-nextcloud.yml) ‚û° disponible sur [http://localhost:8080](http://localhost:8080)
</script></section><section  data-markdown><script type="text/template">
### Configurer WebDAV

**N'importe quelle plateforme qui supporte le protocole WebDAV**

1. Choisir le type de stockage **WebDAV**
2. Entrer l'**URL de stockage** (slides suivantes pour un exemple avec Nextcloud)
3. Choisir ou cr√©er une configuration d'authentification

<br/>
<img src="conf_webdav.png" height="400">
</script></section><section  data-markdown><script type="text/template">
### Nextcloud

1. Cr√©er le dossier de stockage

<br/>
<img src="nextcloud_new_folder.png" height="150"/>
<br/>

2. R√©cup√©rer l'**URL de stockage**

<br/>
<img src="nextcloud_webdav_url.png" height="200"/>
<br/>

3. La coller dans QGIS et y ajouter le nom du dossier cr√©√©

‚ö†Ô∏è terminer par un **/**
<img src="conf_webdav_url.png" height="60"/>
</script></section><section  data-markdown><script type="text/template">
## Les fichiers sont t√©l√©vers√©s/t√©l√©charg√©s

<img src="form_webdav.png"/>
</script></section><section  data-markdown><script type="text/template">
## Visualiseur adaptable

Avec un expression bas√©e sur l'extension du fichier :

<img src="expression_visualiseur.png"/>

```
CASE
WHEN array_contains(array('png', 'jpg', 'jpeg', 'pdf'), lower(file_suffix("url")))
  THEN 'Image'
WHEN array_contains(array('mov', 'm4v', 'mp4', 'mkv'), lower(file_suffix("url")))
  THEN 'Video'
WHEN array_contains(array('mp3', 'aac'), lower(file_suffix("url")))
  THEN 'Audio'
ELSE 'Web'
END
```
</script></section><section  data-markdown><script type="text/template">
### Rangement dans des dossiers

Pr√©parer les dossiers : version WebDAV

```python
# Remplacer par votre URL
url = "http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jvolpes/docs_rang√©s/"

# pour chaque monument
for f in QgsProject.instance().mapLayersByName("monuments")[0].getFeatures():
    # cr√©er le nom du dossier
    req = QNetworkRequest(QUrl(url + f["nom"].replace(" ", "_")))
    # s'authentifier
    QgsApplication.authManager().updateNetworkRequest(req, "41f34j4")
    # cr√©er le dossier
    reply = QgsNetworkAccessManager.instance().sendCustomRequest(req, b"MKCOL")
```

<img src="dossiers_ranges.png" height="280"/>
</script></section><section  data-markdown><script type="text/template">
## Rangement dans des dossiers

Param√©trer l'expression de stockage :

<img src="expression_stockage.png"/>

```
concat(
	-- L'URL de base vers le dossier principal
	'http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jvolpes/docs_rang√©s/',
	
	-- Le nom du monument auquel ce document est li√©, en rempla√ßant les espaces
	replace(attribute(get_feature('monuments', 'id', "monuments_id"), 'nom'), ' ', '_'),
	
	-- le / qui signifie que c'est un dossier
	'/'
)
```
</script></section><section  data-markdown><script type="text/template">
### Stockage sur S3 ‚≠ê New in 3.30 ‚≠ê

Utilisation du stockage **Simple Service Storage** en **buckets** tr√®s utilis√© dans le cloud.

Financ√© par la m√©tropole de Lyon, dont les documents sont stock√©es avec ce protocole.
</script></section><section  data-markdown><script type="text/template">
### Stockage sur S3

‚ö†Ô∏è Il faut utiliser une authentification du type **AWS S3**

<img src="s3_auth.png" height="500"/>
</script></section><section  data-markdown><script type="text/template">
### Quid de la suppression ?

- ‚ö†Ô∏è Pas de suppression du document si:
  - Supprime de l'entit√©
  - Vider/Change le champ **url**

- **Comportement d√©sir√©** ‚û° fonctionnement GitHub/GitLab
</script></section><section  data-markdown><script type="text/template">
### Pourquoi ?

- un document peut √™tre 
  - partag√© entre entit√© (copier-coll√© d'URL entre entit√©)
  - partag√© entre application.

- Il faudrait supprimer √† la sauvegarde **UNIQUEMENT SI** la base est modifi√©e.
  - ‚û° Danger d'incoh√©rence
  - Quid si la base est accessible MAIS PAS le serveur de stockage!!
</script></section><section  data-markdown><script type="text/template">
### Comment Nettoyer

- Nettoyage r√©gulier (cron)
  - Supprimer les orphelins
  - Juste apr√©s un backup des fichiers
- Sur trigger √©ventuellement ‚û° D√©conseill√©
  - Si erreur, on peut perdre des fichiers
</script></section><section  data-markdown><script type="text/template">
### Comment trouver les orphelins

Lister les fichiers en base

```shell
qgis_docs=# select distinct url from documents;
                                                     url                                                     
-------------------------------------------------------------------------------------------------------------
 http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jcabieces/QGISfrdays/cci.jpg
 http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jcabieces/QGISfrdays/la-deesse.jpg
 http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jcabieces/QGISfrdays/Le-parc-de-la-Citadelle.jpg
(3 lignes)
```

... Et sur l'espace de stockage fichier (WebDav dans l'exemple)

```shell
$curl -H "Depth:infinity" -u jcabieces:jcabieces2023$ -XPROPFIND http://ns6640565.ip-51-254-43.eu:4251/remote.php/dav/files/jcabieces/QGISfrdays/ | grep -oP "<d:href>\K[^<]*"
/remote.php/dav/files/jcabieces/QGISfrdays/
/remote.php/dav/files/jcabieces/QGISfrdays/cci.jpg
/remote.php/dav/files/jcabieces/QGISfrdays/grandplace.gif
/remote.php/dav/files/jcabieces/QGISfrdays/la-deesse.jpg
/remote.php/dav/files/jcabieces/QGISfrdays/Le-parc-de-la-Citadelle.jpg
/remote.php/dav/files/jcabieces/QGISfrdays/Porte-de-Paris.jpg
/remote.php/dav/files/jcabieces/QGISfrdays/test/
/remote.php/dav/files/jcabieces/QGISfrdays/test/twitter_logo.svg
```

Faire un diff, et appeller la commande DELETE sur WebDAV

</script></section><section  data-markdown><script type="text/template">

### Indexation des meta donn√©es

- R√©cup√©rer les m√©ta-donn√©es depuis le service de stockage
  - taille
  - mime-type
  - dernier modifi√©
- Pour les stocker en base
- Pourquoi ? Recherche/statistiques/filtrage sur nos documents
  - Exemple: Quels sont les plus gros fichiers ?
</script></section><section  data-markdown><script type="text/template">
### Comment : C√¥t√© QGIS

Configurer les *Valeurs par d√©faut*

<img src="metadata_expr.png" />
</script></section><section  data-markdown><script type="text/template">
### Comment : C√¥t√© QGIS

Configurer l'expression et utiliser du code Python

<img src="get_size_expr.png" />
</script></section><section  data-markdown><script type="text/template">
### Comment : C√¥t√© QGIS

Utiliser le code Python suivant

```python
#Sample custom function file
from qgis.core import *
from qgis.gui import *

from qgis.PyQt.QtNetwork import QNetworkRequest
from qgis.PyQt.QtCore import QEventLoop, QUrl

@qgsfunction(args='auto', group='Custom')
def get_size(url, feature, parent):
    """
    retrieve file size using url
    """
    req = QNetworkRequest(QUrl(url))
    QgsApplication.authManager().updateNetworkRequest(req, "88r5vzl")
    
    loop = QEventLoop()
    reply = QgsNetworkAccessManager.instance().sendCustomRequest(req, b"PROPFIND")
    
    # wait for request to finished
    reply.finished.connect(loop.quit)
    loop.exec()
    
    rep = str(reply.readAll())
    match_tag = "getcontentlength"
    idx = rep.index(match_tag + ">")+len(match_tag)+1
    size=int(rep[idx:rep.index("<",idx)])
    return size
```
</script></section><section  data-markdown><script type="text/template">
### Comment : C√¥t√© base

- Un trigger sur insert, update
- Appel HTTP (avec [pgsql-http](https://github.com/pramsey/pgsql-http) ou urllib dans PL/Python)
- Avantages:
  - Base √©paisse üëç
  - Multi-application / Pas sp√©cifique QGIS
- Inconv√©nient:
  - Disponible uniquement apr√©s enregistrement en base
</script></section><section  data-markdown><script type="text/template">
## Du d√©veloppement sur mesure ?

<div align="left">

Il est possible de d√©velopper **son propre gestionnaire de stockage externe** en Python.

Il faut h√©riter de la classe *QgsExternalStorage*, et impl√©menter les m√©thodes :
- de stockage de la ressource
- de r√©cup√©ration de la ressource

Il est alors possible de g√©rer :
- des **authentifications** particuli√®res
- des pr√©-traitements (renommage de fichiers par exemple)
- des appels √† une **API**
- des arborescences de stockage particuli√®res

</div>
</script></section><section  data-markdown><script type="text/template">
## Du d√©veloppement sur mesure ?

Exemple du plugin NGP Connect utilisant une API sur mesure

<img src="API_NGP_Connect.png"/>
</script></section><section  data-markdown><script type="text/template">
## Si plusieurs types d'objets

- Ex : doc des monuments, doc sur les fleuves, doc sur les magasins
- Le mieux : Une table document par objet
- Sinon : relation polymorphiques
</script></section><section  data-markdown><script type="text/template">
## A venir...

- Stocker/Ouvrir des projets
- Rendu des photos dans la carte
- **D'autre id√©es ?**

üíµBesoin de financementsüíµ
</script></section><section  data-markdown><script type="text/template">
# Questions 

Rencontres des Utilisateurs Francophones de QGIS<br/>
Clermont-Ferrand - 13/03/2023
</td><td><img src="rencontres_header.png" box-shadow="none"></img></td>

Julien Cabieces / Jacky Volpes

<img height=150px src="oslandia_logo_164x164.png">
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
